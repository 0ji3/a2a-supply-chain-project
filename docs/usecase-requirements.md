# 生鮮品サプライチェーン最適化AI協調システム - 要件定義書

## ドキュメント情報

- **プロジェクト名**: 生鮮品サプライチェーン最適化AI協調システム
- **バージョン**: 1.0.0
- **作成日**: 2025-01-22
- **ステータス**: Draft

---

## 1. プロジェクト概要

### 1.1 目的

X402 v2プロトコル、ERC-8004、JPYCを活用したマルチエージェント決済システムの体系的理解とチーム全体へのナレッジ共有。スーパーマーケット事業における最大の経営課題である食品ロス削減と粗利率改善を実現するサンプルアプリケーションの構築。

### 1.2 背景

**事業課題:**
- 食品ロス率: 12%（年間約3億円の損失）
- 西友統合に伴うシステム統合・店舗統合の必要性
- 複数のサプライヤー・物流会社との連携最適化
- DID/VCベースのコンソーシアム認証基盤との統合

**技術的動機:**
- X402 v2プロトコルによるマイクロペイメントの実証
- ERC-8004による自律エージェント管理の実証
- Agent-to-Agent（A2A）経済圏の縮図体験
- Python + Foundry + Anvilでの実装パターン確立

### 1.3 スコープ

**対象商品**: トマト（中玉・国産）1SKU ※MVPフェーズ

**対象プロセス**:
1. 需要予測
2. 在庫最適化・発注計画
3. 動的価格設定
4. サプライヤー品質検証（DID/VC統合）
5. 総合検証
6. 最終意思決定サマリー生成

---

## 2. ユースケース詳細シナリオ

### 2.1 実行タイミング

- **頻度**: 毎日1回
- **時刻**: 深夜2時（発注締切3時間前）
- **処理時間**: 約45秒（並列実行）

### 2.2 エージェント構成

#### エージェント1: 需要予測エージェント

**役割**: 翌日の販売数量を予測

**インプット**:
- 過去3年のPOSデータ（自社）
- 気象庁API（気温・降水確率）
- イベントカレンダー（週末、給料日、祝日）
- 競合価格モニター

**処理**:
- LightGBMモデルで予測
- 信頼区間95%の算出

**アウトプット**:
- 予測販売数量: 350個±30個
- 信頼区間: 320〜380個

**支払いスキーム**: x402 upto方式（データ処理量ベース）
- 基本料金: 3 JPYC
- データ処理量: 0.02 JPYC/1000レコード
- 合計: 10 JPYC

**ERC-8004 Reputation**:
- 過去30日の予測精度: MAPE 8.2%（業界平均15%）
- 評価件数: 892件
- 平均スコア: 87/100

---

#### エージェント2: 在庫最適化エージェント

**役割**: 安全在庫・発注量・発注タイミング算出

**インプット**:
- 需要予測結果: 350個±30個
- 現在在庫: 80個（本日23時時点）
- リードタイム: サプライヤーAから6時間
- 賞味期限: 入荷から3日
- 廃棄コスト: 1個あたり120円

**処理**:
- ニュースベンダーモデルで最適化
- 欠品機会損失 vs 廃棄損失のトレードオフ計算
- サプライヤー別調達コスト比較

**アウトプット**:
- 推奨発注量: 280個
- 発注先: サプライヤーA（単価95円）
- 発注タイミング: 午前5時（開店9時に間に合う）
- 安全在庫: 50個キープ

**支払いスキーム**: x402 exact方式（固定料金）
- 料金: 15 JPYC

**ERC-8004 Reputation**:
- 廃棄率改善実績: 導入前12% → 導入後4.5%
- コスト削減額累計: ¥2,840,000（3ヶ月）

---

#### エージェント3: 動的価格設定エージェント

**役割**: 利益最大化する販売価格を算出

**インプット**:
- 需要の価格弾力性: -1.8
- 競合5店舗の価格: 平均198円
- 調達コスト: 95円
- 在庫状況: 賞味期限近い80個を優先消化
- 顧客セグメント: 時間帯別の価格感度

**処理**:
- 時間帯別の最適価格カーブ算出
- 期待利益の最大化

**アウトプット**:
- 9-12時: 218円（高利益帯）
- 12-18時: 198円（標準価格）
- 18-21時: 168円（在庫処分、競合対抗）
- 期待利益: ¥18,200

**支払いスキーム**: x402 upto方式
- 料金: 12 JPYC

**ERC-8004 Reputation**:
- 粗利率改善: +3.2ポイント
- 売上高改善: +8.7%

---

#### エージェント4: サプライヤー品質検証エージェント

**役割**: サプライヤーの信頼性・品質証明を検証（DID/VC統合）

**インプット**:
- サプライヤーDID
- 産地証明書のVC（Verifiable Credential）
- 過去の品質クレーム履歴
- 配送遅延リスクデータ

**処理**:
- DID/VC基盤で産地証明書を検証
  - 例: 「熊本県産トマト、有機JAS認証」のVC
- 過去の品質クレーム履歴チェック
- 配送遅延リスク評価
- 価格競争力スコアリング

**アウトプット**:
- サプライヤーA: 信頼度95/100（推奨）
- サプライヤーB: 信頼度78/100（品質やや不安定）
- サプライヤーC: 信頼度88/100（価格は安いが配送遅延リスク）

**支払いスキーム**: x402 exact方式
- 料金: 8 JPYC

**ERC-8004 Validation Registry**:
- 検証結果ハッシュをオンチェーン記録
- 監査証跡として永久保存

---

#### エージェント5: 総合検証エージェント

**役割**: 全エージェントの出力整合性を検証（A2A経済圏の本質）

**検証項目**:
1. 需要予測350個 vs 発注量280個 + 在庫80個 = 360個
   → 整合性OK（±3%以内）
2. 価格設定198円 vs 調達コスト95円 = 粗利103円
   → 目標粗利率45%を達成（OK）
3. サプライヤーA選定 vs 品質スコア95点
   → 適切な選択（OK）
4. 賞味期限3日 vs 予測販売期間1.2日
   → 廃棄リスク低（OK）
5. 天候リスク: 降水確率60%
   → 需要予測に織り込み済み（OK）

**アウトプット**:
- 4つのエージェント間で矛盾なし
- 信頼度スコア: 92/100

**支払いスキーム**: x402 exact方式
- 料金: 5 JPYC

**ERC-8004 Validation**:
- 検証結果 + 各エージェントの貢献度をオンチェーン記録
- 不正・改ざん防止

---

#### エージェント6: 最終意思決定サマリー生成

**役割**: バイヤーに提示する実行可能なアクションプラン生成

**アウトプット**:
```
🍅 トマト（中玉・国産）最適化レポート
実行日：2025年1月24日（金）

📦 推奨発注量：280個
🏪 発注先：サプライヤーA（信頼度95点）
⏰ 発注時刻：午前5:00
💰 調達単価：95円/個

💴 推奨販売価格（時間帯別）：
  9-12時：218円
  12-18時：198円
  18-21時：168円（在庫処分）

📊 予測結果：
  - 販売予測：350個（±30個）
  - 廃棄予測：8個（2.3%）
  - 期待粗利：¥18,200
  - ROI改善：+12.5% vs 従来手法

✅ 検証ステータス：信頼度92/100
🔗 オンチェーン記録：0x7a3f...（監査用）
```

**支払いスキーム**: x402 deferred方式（セッション終了時一括）
- 料金: 5 JPYC

---

### 2.3 処理フロー全体

```
実行開始（深夜2:00）
    ↓
[並列実行]
├─ 需要予測エージェント（10 JPYC）
├─ サプライヤー品質検証エージェント（8 JPYC）
└─ 動的価格設定エージェント（12 JPYC）
    ↓
在庫最適化エージェント（15 JPYC）
    ↓
総合検証エージェント（5 JPYC）
    ↓
最終サマリー生成（5 JPYC）
    ↓
完了（深夜2:00:45）

合計コスト：55 JPYC（約55円）
処理時間：約45秒
```

---

## 3. 技術要件

### 3.1 技術スタック

**ブロックチェーン**:
- ローカル開発: Anvil（Foundryのローカルチェーン）
- テストネット: Sepolia
- メインネット: Polygon（本番想定）

**スマートコントラクト**:
- 開発フレームワーク: Foundry
- 言語: Solidity ^0.8.20
- 標準: ERC-8004（Trustless Agents）

**バックエンド**:
- 言語: Python 3.11+
- Web3ライブラリ: web3.py
- エージェントフレームワーク: LangChain or AutoGen
- 機械学習: scikit-learn, LightGBM

**決済プロトコル**:
- X402 v2プロトコル（HTTP 402ベース）
- 決済通貨: JPYC（日本円ステーブルコイン）
- 実装: x402 Python SDK

**DID/VC**:
- 既存のDID/VCコンソーシアム認証基盤と連携
- サプライヤー認証、品質証明書検証

### 3.2 プロトコル活用方針

#### X402 v2プロトコル

| エージェント | 支払いスキーム | 理由 | 金額 |
|------------|--------------|------|------|
| 需要予測 | upto（従量課金） | データ量・計算量に応じて変動 | 10 JPYC |
| 在庫最適化 | exact（固定） | 処理内容が定型的 | 15 JPYC |
| 価格設定 | upto（従量課金） | 競合価格チェック数に応じて | 12 JPYC |
| 品質検証 | exact（固定） | DID/VC検証は定型処理 | 8 JPYC |
| 総合検証 | exact（固定） | 整合性チェックは定型 | 5 JPYC |
| レポート生成 | deferred（後払い） | セッション全体の結果を統合 | 5 JPYC |

#### ERC-8004 活用

**1. Identity Registry（エージェント登録・管理）**

```solidity
// 需要予測エージェント登録例
agentId: 1001
グローバル識別子: retail-ai:137:0x123...#{1001}

メタデータ:
{
  "name": "需要予測エージェントv2.3",
  "category": "demand-forecasting",
  "vendor": "AI Solutions Corp",
  "model": "LightGBM",
  "accuracy_mape": 8.2,
  "training_data_period": "2022-01-01 to 2024-12-31",
  "supported_categories": ["生鮮", "日配", "一般食品"]
}
```

**2. Reputation Registry（評判・実績管理）**

```solidity
// 累積Reputation
{
  "agentId": 1001,
  "totalFeedbacks": 892,
  "averageScore": 87.3,
  "mape": 8.2,
  "costSavings": 2840000,
  "topTags": ["accurate", "fast", "stable"]
}
```

**3. Validation Registry（検証結果記録）**

```solidity
recordValidation(
  taskHash: keccak256("tomato-optimization-20250124"),
  validatorAgentId: 2001,
  result: true,
  confidenceScore: 92,
  proofURI: "ipfs://QmDEF.../validation-proof.json"
)
```

#### JPYC決済

**EIP-3009によるガスレス決済**:
- ユーザーは署名のみでガス代不要
- バックエンドのリレイヤーがtransferWithAuthorizationを実行
- テストネット: faucet.jpyc.jpから取得（15分間隔で1〜100,000 JPYC）

### 3.3 DID/VCコンソーシアム統合

**サプライヤー認証フロー**:

```
サプライヤーA
  ↓ (VCリクエスト)
DID/VC基盤
  ↓ (VC発行: 有機JAS証明書)
サプライヤーA
  ↓ (VC提示)
品質検証エージェント
  ↓ (検証)
DID/VC基盤
  ↓ (検証結果: valid)
品質検証エージェント
  ↓ (信頼度スコア算出: 95/100)
X402決済（8 JPYC）
  ↓
ERC-8004 Validation記録
```

**VCの例**:
```json
{
  "@context": ["https://www.w3.org/2018/credentials/v1"],
  "type": ["VerifiableCredential", "OrganicCertificate"],
  "issuer": "did:web:organic-jas.go.jp",
  "credentialSubject": {
    "id": "did:web:supplier-a.example.com",
    "product": "トマト",
    "certification": "有機JAS",
    "origin": "熊本県",
    "validUntil": "2026-03-31"
  },
  "proof": { /* ERC-8004のagentIdと紐付け */ }
}
```

---

## 4. 期待効果・KPI

### 4.1 定量的効果

| 指標 | 現状 | 目標 | 改善率 |
|------|------|------|--------|
| 食品ロス率 | 12% | 4.5% | -62.5% |
| 廃棄コスト（年間） | 3億円 | 1.1億円 | -63% |
| 粗利率 | 42% | 45.2% | +3.2pt |
| 予測精度（MAPE） | 15% | 8.2% | -45% |
| 意思決定時間 | 30分/商品 | 45秒/商品 | -97.5% |

**ROI試算（1店舗・1商品あたり）**:
- 日次利益改善: ¥1,200
- 月次利益改善: ¥36,000
- エージェント利用料: ¥55/日 = ¥1,650/月
- ROI: 2,182%

**全店舗スケール時（300店舗・200商品）**:
- 月次利益改善: ¥2,160万円
- 年間利益改善: ¥2.592億円
- 年間システムコスト: ¥1,188万円（200商品 × 300店 × 55円 × 30日 × 12ヶ月）
- 純効果: ¥2.473億円/年

### 4.2 定性的効果

**チームへの価値**:
- X402 v2プロトコルの実践的理解
- ERC-8004による自律エージェント管理の実証
- A2A経済圏の縮図体験
- Python + Foundry + Anvilでの開発パターン習得

**ビジネスへの価値**:
- 西友統合時のシステム統合モデルケース
- DID/VCコンソーシアムとブロックチェーンの融合実証
- 監査証跡の自動化（食品安全法対応）
- サプライヤーとの信頼関係強化

---

## 5. 実装フェーズ

### Phase 1: MVP（1-2週間）

**スコープ**:
- 対象: 1店舗、10商品カテゴリ
- エージェント: 需要予測 + 在庫最適化のみ
- チェーン: Anvil（ローカル）
- 決済: x402 exact方式のみ

**成果物**:
- 基本的なエージェント動作確認
- X402決済フローの実装
- 簡易レポート生成

**検証ポイント**:
- プロトコルの基本動作
- エージェント間通信
- 決済フローの安定性

---

### Phase 2: プロトコル拡張（1週間）

**追加要素**:
- 動的価格設定エージェント追加
- ERC-8004 Identity Registry実装
- x402 upto方式決済導入
- Sepolia testnet展開

**成果物**:
- 3つのエージェント協調動作
- ERC-8004エージェント登録機能
- 従量課金決済の実装

**検証ポイント**:
- マイクロペイメントの価値実証
- エージェントID管理

---

### Phase 3: 信頼レイヤー追加（2週間）★A2A経済圏の本質

**追加要素**:
- サプライヤー品質検証エージェント（DID/VC統合）
- 総合検証エージェント
- ERC-8004 Reputation Registry実装
- ERC-8004 Validation Registry実装
- x402 deferred方式決済導入

**成果物**:
- DID/VCコンソーシアム連携
- 検証結果のオンチェーン記録
- 全6エージェントの協調動作
- 監査証跡機能

**検証ポイント**:
- A2A経済圏の動作実証
- 信頼性・透明性の確保
- システム統合（既存DID/VC基盤）

---

### Phase 4: 西友統合・スケール（3ヶ月）

**追加要素**:
- 既存チェーン150店舗展開
- 西友150店舗展開
- 200商品カテゴリ対応
- データ正規化エージェント追加
- 本番環境（Polygon）移行

**成果物**:
- 全店舗・全商品カテゴリ対応
- 統一オペレーション基盤
- ダッシュボード・モニタリング機能

**検証ポイント**:
- スケーラビリティ
- 運用安定性
- ROI実証

---

## 6. リスク・制約事項

### 6.1 技術的リスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| エージェント予測精度不足 | 高 | Phase 1で精度検証、閾値未達なら人間判断併用 |
| ブロックチェーン遅延 | 中 | Layer2（Polygon）使用、オフチェーン処理活用 |
| JPYC流動性不足 | 中 | テストネットで十分検証、本番はステーブルコイン選択肢拡大 |
| DID/VC基盤障害 | 中 | キャッシュ機構、フォールバック処理 |

### 6.2 ビジネスリスク

| リスク | 影響度 | 対策 |
|--------|--------|------|
| バイヤーの抵抗感 | 高 | Phase 1で人間判断併用、徐々に自動化 |
| サプライヤー対応遅延 | 中 | DID/VC登録サポート体制構築 |
| 法規制対応 | 低 | 食品安全法等の監査証跡をオンチェーン記録 |

### 6.3 制約事項

- MVP段階では完全自動化せず、人間の最終承認を必須とする
- 生鮮品以外の商品カテゴリへの適用は別途検証が必要
- ガス代変動リスクのため、本番環境ではLayer2を推奨

---

## 7. 成功基準

### Phase 1（MVP）
- [ ] 需要予測MAPE 15%以下
- [ ] エージェント実行時間 60秒以内
- [ ] X402決済成功率 99%以上

### Phase 2（プロトコル拡張）
- [ ] ERC-8004エージェント登録成功
- [ ] 3つの支払いスキーム全て動作確認
- [ ] Sepolia testnet安定稼働

### Phase 3（信頼レイヤー）
- [ ] DID/VC検証成功率 100%
- [ ] 検証結果オンチェーン記録成功
- [ ] 6エージェント協調動作確認

### Phase 4（本番展開）
- [ ] 食品ロス率 8%以下（目標4.5%への中間）
- [ ] 粗利率 +2ポイント以上改善
- [ ] システム稼働率 99.9%以上

---

## 8. 参考資料

### 8.1 技術ドキュメント

- X402: https://x402.org, https://github.com/coinbase/x402
- ERC-8004: https://eips.ethereum.org/EIPS/eip-8004
- JPYC: https://jpyc.gitbook.io/jpyc/developer/jpyc-v2/documentation-en
- Foundry: https://book.getfoundry.sh
- A2A Protocol: https://a2a-protocol.org

### 8.2 関連プロジェクト

- DID/VCコンソーシアム認証基盤（社内プロジェクト）
- 西友統合プロジェクト（社内プロジェクト）

---

## 9. 承認・レビュー履歴

| 日付 | バージョン | 承認者 | コメント |
|------|-----------|--------|---------|
| 2025-01-22 | 1.0.0 | - | 初版作成 |

---

## 10. 付録

### 10.1 用語集

- **A2A (Agent-to-Agent)**: エージェント間通信・協調
- **X402**: HTTP 402ステータスコードを活用したマイクロペイメントプロトコル
- **ERC-8004**: Trustless Agents標準、エージェントのID・評判・検証を管理
- **JPYC**: 日本円連動型ステーブルコイン
- **DID**: Decentralized Identifier（分散型識別子）
- **VC**: Verifiable Credential（検証可能な資格情報）
- **MAPE**: Mean Absolute Percentage Error（平均絶対パーセント誤差）
- **ニュースベンダーモデル**: 在庫最適化の確率モデル

### 10.2 システム関連図索引

（後続のドキュメントで作成予定）
- システムアーキテクチャ図（C4モデル）
- シーケンス図（各エージェントフロー）
- データフロー図
- ER図（オンチェーン/オフチェーンデータ）